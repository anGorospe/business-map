<!DOCTYPE html>
<html>
<head>
    <title>Business Map with Sidebar & Distance (Miles)</title>
    <style>
        html, body { margin: 0; padding: 0; height: 100%; }
        #map { height: 100%; width: 100%; }
        #menu {
            position: absolute;
            left: 10px;
            top: 10px;
            width: 250px;
            max-height: 90vh;
            overflow-y: auto;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            font-family: Arial, sans-serif;
            z-index: 10;
        }
        #menu h2 { margin-top: 0; font-size: 18px; }
        .biz-item { cursor: pointer; margin-bottom: 5px; padding: 3px; border-radius: 3px; }
        .biz-item:hover { background: #eee; }
    </style>
</head>
<body>
<div id="menu">
    <h2>Businesses</h2>
    <div id="bizList"></div>
</div>
<div id="map"></div>

<script>
const SHEET_ID = "1mQud7yhTLBBZDreCshvwUZxas3-bL45m_5O3c2SVO10";
const RANGE = "Sheet1!A:H";
const API_KEY = "AIzaSyAdMrHW4487TYOWq2Eyf0QH7Yzlwkc7d68";

let map;
let businesses = [];
let userPosition = null;

// Fetch businesses from Google Sheet
async function fetchSheetData() {
    try {
        const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`);
        const data = await res.json();
        if (!data.values || data.values.length < 2) return [];
        const columns = data.values[0];
        return data.values.slice(1).map((row, i) => {
            const obj = { _rowIndex: i };
            columns.forEach((col, j) => obj[col] = row[j] || "0");
            return obj;
        });
    } catch (err) {
        console.error("Failed to fetch sheet:", err);
        return [];
    }
}

// Initialize map
async function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 34.0195, lng: -118.4912 }, // Santa Monica
        zoom: 13
    });

    // Get user location
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
            userPosition = new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
            new google.maps.Marker({
                position: userPosition,
                map: map,
                title: "You are here",
                icon: { path: google.maps.SymbolPath.CIRCLE, scale: 8, fillColor: "blue", fillOpacity: 1, strokeColor: "white", strokeWeight: 2 }
            });
            updateDistances(); // update distances once we have user position
        }, err => { console.warn("Geolocation error:", err); });
    }

    businesses = await fetchSheetData();
    if (businesses.length === 0) { console.warn("No businesses loaded"); return; }

    businesses.forEach(addMarker);
    populateMenu();
    updateDistances();
}

// Add marker and info window
function addMarker(biz) {
    const lat = parseFloat(biz.Lat);
    const lng = parseFloat(biz.Lng);
    if (!lat || !lng) return;

    const marker = new google.maps.Marker({
        position: { lat, lng },
        map: map,
        title: biz.Name
    });

    const content = document.createElement('div');
    content.innerHTML = `
        <h3>${biz.Name}</h3>
        <p>${biz.Description}</p>
        <p>${biz.Hours}</p>
    `;

    const infoWindow = new google.maps.InfoWindow({ content });
    marker.addListener('click', () => infoWindow.open(map, marker));
}

// Populate sidebar menu
function populateMenu() {
    const list = document.getElementById('bizList');
    list.innerHTML = "";
    businesses.forEach(biz => {
        const div = document.createElement('div');
        div.className = "biz-item";
        div.id = `menu-${biz._rowIndex}`;
        div.innerHTML = `${biz.Name}`;
        div.addEventListener('click', () => {
            map.setCenter({ lat: parseFloat(biz.Lat), lng: parseFloat(biz.Lng) });
            map.setZoom(16);
        });
        list.appendChild(div);
    });
}

// Update distances in sidebar (imperial)
function updateDistances() {
    if (!userPosition) return;
    businesses.forEach(biz => {
        const bizLatLng = new google.maps.LatLng(parseFloat(biz.Lat), parseFloat(biz.Lng));
        const distanceMeters = google.maps.geometry.spherical.computeDistanceBetween(userPosition, bizLatLng);
        const distanceMiles = (distanceMeters * 0.000621371).toFixed(2); // meters â†’ miles
        biz.distance = distanceMiles;

        const menuDiv = document.getElementById(`menu-${biz._rowIndex}`);
        if (menuDiv) {
            menuDiv.innerHTML = `${biz.Name} (${distanceMiles} mi)`;
        }
    });

    // Sort sidebar by distance
    const menuList = document.getElementById('bizList');
    const items = Array.from(menuList.children);
    items.sort((a,b) => {
        const aIndex = parseInt(a.id.replace("menu-",""));
        const bIndex = parseInt(b.id.replace("menu-",""));
        return businesses[aIndex].distance - businesses[bIndex].distance;
    });
    items.forEach(item => menuList.appendChild(item));
}
</script>

<!-- Google Maps API with geometry library -->
<script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAdMrHW4487TYOWq2Eyf0QH7Yzlwkc7d68&libraries=geometry&callback=initMap">
</script>
</body>
</html>
