<!DOCTYPE html>
<html>
<head>
    <title>EBB Helper</title>
    <style>
        html, body { margin: 0; padding: 0; height: 100%; }
        #map { height: 100%; width: 100%; }
        #menu {
            position: absolute;
            left: 10px;
            top: 10px;
            width: 250px;
            max-height: 90vh;
            overflow-y: auto;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            font-family: Arial, sans-serif;
            z-index: 10;
        }
        #menu h2 { margin-top: 0; font-size: 18px; }
        .biz-item { cursor: pointer; margin-bottom: 5px; padding: 3px; border-radius: 3px; }
        .biz-item:hover { background: #eee; }
        button { cursor: pointer; margin-top: 5px; }

        /* Footer */
        #footer {
            position: absolute;
            bottom: 5px;
            right: 10px;
            font-family: Arial, sans-serif;
            font-size: 12px;
            color: #555;
            z-index: 10;
        }
    </style>
</head>
<body>
<div id="menu">
    <h2>Businesses</h2>
    <div id="bizList"></div>
</div>
<div id="map"></div>
<div id="footer">Created by Angelo Gorospe</div>

<script>
const SHEET_ID = "1mQud7yhTLBBZDreCshvwUZxas3-bL45m_5O3c2SVO10";
const RANGE = "Sheet1!A:H";
const API_KEY = "AIzaSyAdMrHW4487TYOWq2Eyf0QH7Yzlwkc7d68";

let map;
let businesses = [];
let userPosition = null;

// Fetch businesses from Google Sheet
async function fetchSheetData() {
    try {
        const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`);
        const data = await res.json();
        if (!data.values || data.values.length < 2) return [];
        const columns = data.values[0];
        return data.values.slice(1).map((row, i) => {
            const obj = { _rowIndex: i };
            columns.forEach((col, j) => obj[col] = row[j] || "0");
            return obj;
        });
    } catch (err) {
        console.error("Failed to fetch sheet:", err);
        return [];
    }
}

// Initialize map
async function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 34.0195, lng: -118.4912 }, // Santa Monica
        zoom: 13
    });

    businesses = await fetchSheetData();
    if (businesses.length === 0) { console.warn("No businesses loaded"); return; }

    businesses.forEach(addMarker);

    // Attempt to get user location
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
            userPosition = new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
            new google.maps.Marker({
                position: userPosition,
                map: map,
                title: "You are here",
                icon: { path: google.maps.SymbolPath.CIRCLE, scale: 8, fillColor: "blue", fillOpacity: 1, strokeColor: "white", strokeWeight: 2 }
            });
            updateDistances();
        }, err => {
            console.warn("Geolocation error:", err);
            populateMenu(); // Fallback if location denied
        });
    } else {
        populateMenu(); // Browser doesn't support geolocation
    }
}

// Add marker and info window with Get Directions button
function addMarker(biz) {
    const lat = parseFloat(biz.Lat);
    const lng = parseFloat(biz.Lng);
    if (!lat || !lng) return;

    const marker = new google.maps.Marker({
        position: { lat, lng },
        map: map,
        title: biz.Name
    });

    const content = document.createElement('div');
    content.innerHTML = `
        <h3>${biz.Name}</h3>
        <p>${biz.Description}</p>
        <p>${biz.Hours}</p>
        <button id="directions-${biz._rowIndex}">Get Directions</button>
    `;

    const infoWindow = new google.maps.InfoWindow({ content });
    marker.addListener('click', () => {
        infoWindow.open(map, marker);

        google.maps.event.addListenerOnce(infoWindow, 'domready', () => {
            const btn = document.getElementById(`directions-${biz._rowIndex}`);
            if (btn) {
                btn.addEventListener('click', () => {
                    if (!userPosition) {
                        alert("User location not available");
                        return;
                    }

                    const start = `${userPosition.lat()},${userPosition.lng()}`;
                    const dest = `${biz.Lat},${biz.Lng}`;
                    const url = `https://www.google.com/maps/dir/?api=1&origin=${start}&destination=${dest}&travelmode=driving`;
                    
                    window.open(url, '_blank');
                });
            }
        });
    });
}

// Populate sidebar menu
function populateMenu() {
    const list = document.getElementById('bizList');
    list.innerHTML = "";
    businesses.forEach(biz => {
        const div = document.createElement('div');
        div.className = "biz-item";
        div.id = `menu-${biz._rowIndex}`;
        const distText = biz.distance !== undefined ? ` (${biz.distance} mi)` : "";
        div.innerHTML = `${biz.Name}${distText}`;
        div.addEventListener('click', () => {
            map.setCenter({ lat: parseFloat(biz.Lat), lng: parseFloat(biz.Lng) });
            map.setZoom(16);
        });
        list.appendChild(div);
    });
}

// Update distances in sidebar (miles) and sort closest â†’ farthest
function updateDistances() {
    if (!userPosition) {
        populateMenu(); // fallback if no location
        return;
    }

    businesses.forEach(biz => {
        const bizLatLng = new google.maps.LatLng(parseFloat(biz.Lat), parseFloat(biz.Lng));
        const distanceMeters = google.maps.geometry.spherical.computeDistanceBetween(userPosition, bizLatLng);
        biz.distance = parseFloat((distanceMeters * 0.000621371).toFixed(2)); // miles
    });

    // Sort businesses by distance
    businesses.sort((a, b) => a.distance - b.distance);

    // Update sidebar
    populateMenu();
}
</script>

<!-- Google Maps API with geometry library -->
<script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAdMrHW4487TYOWq2Eyf0QH7Yzlwkc7d68&libraries=geometry&callback=initMap">
</script>
</body>
</html>
