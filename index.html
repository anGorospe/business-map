<!DOCTYPE html>
<html>
<head>
    <title>EBB Helper</title>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            font-family: Arial, sans-serif;
        }
        #map {
            height: 100%;
            width: 75%;
            float: right;
        }
        #sidebar {
            width: 25%;
            height: 100%;
            float: left;
            overflow-y: auto;
            padding: 10px;
            box-sizing: border-box;
            background-color: #f8f8f8;
        }
        .business-item {
            margin-bottom: 10px;
        }
        .closed {
            color: gray;
        }
        #toggleWrapper {
            margin-top: 10px;
            font-size: 14px;
        }
        #footer {
            position: absolute;
            bottom: 5px;
            right: 10px;
            font-size: 12px;
            color: #555;
        }
    </style>
</head>
<body>
    <div id="sidebar">
        <h2>Businesses</h2>
        <div id="businessList"></div>
        <div id="toggleWrapper">
            <label>
                <input type="checkbox" id="showClosedToggle"> Show closed businesses on map
            </label>
        </div>
    </div>
    <div id="map"></div>
    <div id="footer">Created by Angelo Gorospe</div>

    <!-- Google Maps API (single load with geometry library) -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAdMrHW4487TYOWq2Eyf0QH7Yzlwkc7d68&callback=initMap&libraries=geometry" async defer></script>

    <script>
        let map;
        let businesses = [];
        let bizMarkers = [];

        // Replace this with your published Google Sheets CSV URL
        const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQDzM3Nu-ROuwXQqfAamzS8iG2qTOEYTR8-uh2X0XeWUtlcAJ-G9bkqACZWgZTFJW3zlwKOfxeNYzoi/pub?output=csv';

        function initMap() {
            // Default: Santa Monica center
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 34.0195, lng: -118.4912 },
                zoom: 13
            });

            fetchBusinesses();

            document.getElementById("showClosedToggle").addEventListener("change", () => {
                renderMarkers();
                renderBusinessList();
            });
        }

        function fetchBusinesses() {
            fetch(SHEET_CSV_URL)
                .then(res => res.text())
                .then(csvText => {
                    businesses = parseCSV(csvText);
                    updateDistances();
                    renderBusinessList();
                    renderMarkers();
                })
                .catch(err => console.error("Error fetching sheet:", err));
        }

        function parseCSV(csv) {
            const lines = csv.trim().split("\n");
            const headers = lines.shift().split(",");
            return lines.map((line, idx) => {
                const data = line.split(",");
                const obj = {};
                headers.forEach((h, i) => {
                    obj[h.trim()] = data[i] ? data[i].trim() : "";
                });
                obj._rowIndex = idx;
                return obj;
            });
        }

        function isOpen(hoursStr) {
            if (!hoursStr) return true;
            if (hoursStr.toLowerCase() === "24 hours") return true;

            const now = new Date();

            const parts = hoursStr.split("-");
            if (parts.length !== 2) return true;

            const parseTime = (str) => {
                let [time, modifier] = str.trim().split(" ");
                let [hours, minutes] = time.split(":").map(Number);
                if (modifier) {
                    if (modifier.toLowerCase() === "pm" && hours < 12) hours += 12;
                    if (modifier.toLowerCase() === "am" && hours === 12) hours = 0;
                }
                return { hours, minutes };
            };

            const openT = parseTime(parts[0]);
            const closeT = parseTime(parts[1]);

            const openDate = new Date(now);
            openDate.setHours(openT.hours, openT.minutes, 0, 0);

            const closeDate = new Date(now);
            closeDate.setHours(closeT.hours, closeT.minutes, 0, 0);

            // Handle overnight closing
            if (closeDate <= openDate) closeDate.setDate(closeDate.getDate() + 1);

            return now >= openDate && now <= closeDate;
        }

        function updateDistances() {
            if (!navigator.geolocation) return;
            navigator.geolocation.getCurrentPosition(pos => {
                const userLat = pos.coords.latitude;
                const userLng = pos.coords.longitude;
                businesses.forEach(biz => {
                    const lat = parseFloat(biz.Lat);
                    const lng = parseFloat(biz.Lng);
                    biz.distance = ((google.maps.geometry.spherical.computeDistanceBetween(
                        new google.maps.LatLng(userLat, userLng),
                        new google.maps.LatLng(lat, lng)
                    )) / 1609.34).toFixed(2); // miles
                });
                renderBusinessList();
            });
        }

        function renderBusinessList() {
            const list = document.getElementById("businessList");
            list.innerHTML = "";

            const showClosed = document.getElementById("showClosedToggle")?.checked;
            const openBusinesses = [];
            const closedBusinesses = [];

            businesses.forEach(biz => {
                const open = isOpen(biz.Hours);
                if (open) openBusinesses.push(biz);
                else closedBusinesses.push(biz);
            });

            const toShow = showClosed ? [...openBusinesses, ...closedBusinesses] : openBusinesses;
            toShow.sort((a,b) => (a.distance || 0) - (b.distance || 0));

            toShow.forEach(biz => {
                const open = isOpen(biz.Hours);
                const directionsUrl = `https://www.google.com/maps/dir/?api=1&destination=${biz.Lat},${biz.Lng}&travelmode=driving`;

                const item = document.createElement("div");
                item.className = "business-item";
                item.style.padding = "8px";
                item.style.borderBottom = "1px solid #ddd";
                item.style.cursor = "pointer";
                item.style.backgroundColor = open ? "white" : "#f0f0f0";

                item.innerHTML = `
                    <div style="font-weight: bold;">${biz.Name}</div>
                    <div style="font-size: 13px; color: #555;">${biz.Description || ""}</div>
                    <div style="font-size: 12px; margin-top: 2px;">${biz.Hours || ""}</div>
                    <div style="margin-top: 4px; ${open ? "color: green;" : "color: red;"} font-weight: bold;">
                        ${open ? "Open" : "Closed"}
                    </div>
                    ${biz.distance ? `<div style="font-size:12px; margin-top:2px;">${biz.distance} mi</div>` : ""}
                    <a href="${directionsUrl}" target="_blank" style="
                        display: inline-block;
                        padding: 4px 8px;
                        margin-top: 6px;
                        background-color: #4285F4;
                        color: white;
                        text-decoration: none;
                        border-radius: 4px;
                        font-size: 12px;
                    ">Get Directions</a>
                `;

                item.addEventListener("click", () => {
                    map.setCenter({ lat: parseFloat(biz.Lat), lng: parseFloat(biz.Lng) });
                    map.setZoom(15);
                });

                list.appendChild(item);
            });
        }

        function renderMarkers() {
            if (bizMarkers.length) {
                bizMarkers.forEach(m => m.setMap(null));
            }
            bizMarkers = [];

            const showClosed = document.getElementById("showClosedToggle")?.checked;
            const toShow = showClosed ? businesses : businesses.filter(biz => isOpen(biz.Hours));

            toShow.forEach(biz => {
                const open = isOpen(biz.Hours);
                const marker = new google.maps.Marker({
                    position: { lat: parseFloat(biz.Lat), lng: parseFloat(biz.Lng) },
                    map,
                    title: biz.Name,
                    icon: open 
                        ? "http://maps.google.com/mapfiles/ms/icons/red-dot.png"
                        : "http://maps.google.com/mapfiles/ms/icons/grey-dot.png"
                });

                const directionsUrl = `https://www.google.com/maps/dir/?api=1&destination=${biz.Lat},${biz.Lng}&travelmode=driving`;
                const info = new google.maps.InfoWindow({
                    content: `
                        <div style="font-family: Arial, sans-serif; font-size: 14px; max-width: 250px;">
                            <b>${biz.Name}</b><br>
                            ${biz.Description ? biz.Description + "<br>" : ""}
                            ${biz.Hours ? biz.Hours + "<br>" : ""}
                            ${open 
                                ? `<span style="color: green; font-weight: bold;">Open</span>` 
                                : `<span style="color: red; font-weight: bold;">Closed</span>`
                            }
                            <br><br>
                            <a href="${directionsUrl}" target="_blank" style="
                                display: inline-block;
                                padding: 6px 10px;
                                margin-top: 5px;
                                background-color: #4285F4;
                                color: white;
                                text-decoration: none;
                                border-radius: 4px;
                                font-size: 13px;
                            ">Get Directions</a>
                        </div>
                    `
                });

                marker.addListener("click", () => {
                    info.open(map, marker);
                });

                bizMarkers.push(marker);
            });
        }
    </script>
</body>
</html>
